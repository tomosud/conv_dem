# EXR Tools & Heightmap Viewer

国土地理院のDEM5AデータをOpenEXR形式に変換し、ブラウザで3D可視化するツールセット

## 構成

1. **DEM Stitch Tool**: XMLタイルをEXRに変換
2. **EXR Heightmap Viewer**: ブラウザでEXRを3D表示

---

## DEM Stitch Tool

国土地理院の DEM5A（FGD GML, XML）タイル群を結合して OpenEXR 形式で出力するツール

### 機能

- XML タイル群を自動的に結合（モザイク）
- NumPy 配列として標高データを統合
- OpenEXR（単チャンネル, float32）形式で出力
- タイルサイズを XML から自動検出
- 出力ファイル名をフォルダ名に自動設定
- **緯度経度の縦横比を自動補正したリサイズ版も同時出力**

### セットアップ

#### 1. 初回セットアップ
```
setup.bat
```
- 仮想環境の作成
- 必要なライブラリのインストール（numpy, OpenEXR, chardet）

#### 2. 使用方法
```
XMLフォルダ を stitch.bat にドラッグ&ドロップ
```

### 出力ファイル

処理が完了すると、ドロップしたフォルダ内に以下が生成されます：

**オリジナル（リサイズ前）:**
- `{フォルダ名}.exr` - OpenEXR 形式の統合標高データ
- `{フォルダ名}_mask.exr` - OpenEXR 形式の欠損マスク（補間前、0=欠損、1=有効）

**リサイズ版（緯度経度比補正後）:**
- `{フォルダ名}_resized.exr` - 緯度経度比補正済み標高データ
- `{フォルダ名}_mask_resized.exr` - 緯度経度比補正済み欠損マスク

**その他:**
- `{フォルダ名}.npy` - NumPy バイナリ形式（オプション）
- `dem_merged_shape.txt` - 処理ログ（タイル数、グリッドサイズ等）

---

## EXR Heightmap Viewer

GitHub Pages対応のEXRハイトマップビュワーです。EXRファイルをドラッグ＆ドロップするだけで、3Dの地形メッシュとして表示できます。

### 機能

- **EXRファイル対応**: 高精度な標高データ（float32）を読み込み
- **3D可視化**: Three.jsを使用した高品質な3Dレンダリング
- **インタラクティブ**: マウスでの視点操作（回転、ズーム、パン）
- **グリッド解像度**: 1mグリッドと5mグリッドの切り替え
- **リアルタイム処理**: ブラウザ上でリアルタイムに処理
- **ライティング**: 自然な陰影表現
- **高度カラーリング**: 標高に応じた色分け表示

### 使い方

#### 1. ローカル開発サーバーの起動

```bash
# Python 3を使用
python server.py

# または
python -m http.server 8000
```

ブラウザで `http://localhost:8000` にアクセス

#### 2. EXRファイルの読み込み

1. ドロップゾーンにEXRファイルをドラッグ＆ドロップ
2. またはドロップゾーンをクリックしてファイル選択ダイアログから選択

#### 3. 操作方法

- **マウス左ドラッグ**: 視点回転
- **マウスホイール**: ズーム
- **マウス右ドラッグ**: パン（移動）
- **グリッドボタン**: 1mグリッド/5mグリッド切り替え
- **視点リセット**: 初期視点に戻る

### 技術仕様

#### サポートファイル形式
- **EXR**: OpenEXR形式の単チャンネルfloat32データ
- **データ形式**: 標高値（メートル単位）

#### パフォーマンス最適化
- **グリッドサイズ**: 1024x1024に最適化
- **メモリ効率**: 大容量EXRファイルに対応
- **レンダリング**: ハードウェアアクセラレーション対応

#### 互換性
- **ブラウザ**: WebGL対応の現代的ブラウザ
- **GitHub Pages**: 完全対応
- **CDN**: Three.js等はCDNから読み込み

### ファイル構成

```
├── index.html              # メインHTMLファイル
├── js/
│   └── main.js             # メインJavaScript
├── server.py               # 開発用HTTPサーバー
├── server.bat              # Windows用サーバー起動スクリプト
├── PLAN.md                 # 実装計画書
└── README.md               # このファイル
```

### GitHub Pagesでの公開

このプロジェクトはGitHub Pagesで直接公開できます：

1. リポジトリをGitHubにプッシュ
2. Settings > Pages でソースをmainブランチに設定
3. 提供されるURLでアクセス

### サンプルファイル

テスト用の巨大EXRファイル：
- `viewer/FG-GML-523506-DEM1A-20250606_resized.exr`

---

## トラブルシューティング

### DEM Stitch Tool

- **"Virtual environment not found"エラー**: `setup.bat` を先に実行してください
- **OpenEXRエラー**: `requirements.txt` を確認し、`setup.bat` を再実行してください
- **文字化けエラー**: すべてのBATファイルは英語メッセージで作成されています

### EXR Heightmap Viewer

#### よくある問題

1. **EXRファイルが読み込めない**
   - ファイル形式がOpenEXR float32であることを確認
   - ブラウザのコンソールでエラーメッセージを確認

2. **パフォーマンスが悪い**
   - ファイルサイズが大きすぎる場合はリサイズを検討
   - 5mグリッドモードで処理を軽量化

3. **表示が正しくない**
   - EXRファイルの座標系やデータ形式を確認
   - ブラウザのWebGLサポートを確認

#### ブラウザサポート

- Chrome 58+
- Firefox 53+
- Safari 11+
- Edge 79+

#### 制限事項

- 非常に大きなEXRファイル（>100MB）では処理に時間がかかる場合があります
- モバイルデバイスではパフォーマンスが制限される場合があります

## 動作環境

- Windows
- Python 3.11
- 必要ライブラリ: numpy, OpenEXR, chardet

## ライセンス

このプロジェクトは教育・研究目的で作成されました。Three.jsおよび関連ライブラリのライセンスに従います。