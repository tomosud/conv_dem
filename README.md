# DEM Stitch Tool

国土地理院の DEM5A（FGD GML, XML）タイル群を結合して OpenEXR 形式で出力するツール

## 機能

- XML タイル群を自動的に結合（モザイク）
- NumPy 配列として標高データを統合
- OpenEXR（単チャンネル, float32）形式で出力
- タイルサイズを XML から自動検出
- 出力ファイル名をフォルダ名に自動設定
- **緯度経度の縦横比を自動補正したリサイズ版も同時出力**

## セットアップ

### 1. 初回セットアップ
```
setup.bat
```
- 仮想環境の作成
- 必要なライブラリのインストール（numpy, OpenEXR, chardet）

### 2. 使用方法
```
XMLフォルダ を stitch.bat にドラッグ&ドロップ
```

## 出力ファイル

処理が完了すると、ドロップしたフォルダ内に以下が生成されます：

**オリジナル（リサイズ前）:**
- `{フォルダ名}.exr` - OpenEXR 形式の統合標高データ
- `{フォルダ名}_mask.exr` - OpenEXR 形式の欠損マスク（補間前、0=欠損、1=有効）

**リサイズ版（緯度経度比補正後）:**
- `{フォルダ名}_resized.exr` - 緯度経度比補正済み標高データ
- `{フォルダ名}_mask_resized.exr` - 緯度経度比補正済み欠損マスク

**その他:**
- `{フォルダ名}.npy` - NumPy バイナリ形式（オプション）
- `dem_merged_shape.txt` - 処理ログ（タイル数、グリッドサイズ等）

## 動作環境

- Windows
- Python 3.11
- 必要ライブラリ: numpy, OpenEXR, chardet

## トラブルシューティング

- **"Virtual environment not found"エラー**: `setup.bat` を先に実行してください
- **OpenEXRエラー**: `requirements.txt` を確認し、`setup.bat` を再実行してください
- **文字化けエラー**: すべてのBATファイルは英語メッセージで作成されています

## 仕様

- タイルサイズ: 最初のXMLから自動検出（例: 225×150）
- 座標系: 緯度・経度（北を上、東を右）
- 欠損値: -9990以下の値 → 0 に変換
- 小さな欠損領域: 高速ランダムサンプリング補間（30回反復）
- 出力形式: 単チャンネル EXR, float32（標高データと欠損マスクは別ファイル）

### リサイズ機能

- **緯度経度比補正**: 緯度の中央値での cos 補正を適用
- **横幅調整**: 縦解像度は維持し、横解像度のみを補正（`1.0 / scale_x`）
- **補間方式**: リニア補間を使用
- **自動処理**: オリジナル版とリサイズ版の両方を自動生成